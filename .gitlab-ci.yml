include:
  - remote: 'https://gitlab.com/clambin/gitlab-ci-templates/raw/python38/python-tests.yml'
  - remote: 'https://gitlab.com/clambin/gitlab-ci-templates/-/raw/k3s-dynamic-tag/k3s-docker-build-multiarch.yml'
  - remote: 'https://gitlab.com/clambin/gitlab-ci-templates/-/raw/k3s-dynamic-tag/k3s-deploy.yml'

stages:
  - unittest
  - build
  - release
  - deploy

prometheus:
  stage: unittest
  image: python:3.8
  before_script:
    - pip install pipenv
    - pipenv install
  script:
    - pipenv run python vpnmon.py --debug --interval 1 --client-status tests/client.status &
    - TESTPIP=$?
    - sleep 5
    - curl -s localhost:8080/metric | grep '^openvpn_client_auth_read_bytes_total'
